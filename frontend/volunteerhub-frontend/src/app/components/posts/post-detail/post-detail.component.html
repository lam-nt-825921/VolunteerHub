<app-navbar></app-navbar>

<div class="post-detail-container">
  <div class="post-detail-content">
    @if (isLoading()) {
      <div class="loading-state">
        <mat-icon>refresh</mat-icon>
        <p>Đang tải bài viết...</p>
      </div>
    } @else if (post()) {
      <!-- Post Card -->
      <div class="post-card">
        <div class="post-header">
          <div class="author-info">
            <div class="author-avatar">
              {{ getInitials(post()!.author.fullName) }}
            </div>
            <div class="author-details">
              <strong>{{ post()!.author.fullName }}</strong>
              <span class="post-date">{{ formatDate(post()!.createdAt) }}</span>
            </div>
          </div>
          <button class="back-btn" (click)="navigateToEvent(post()!.eventId)" type="button">
            <mat-icon>arrow_back</mat-icon>
            <span>Về sự kiện</span>
          </button>
        </div>

        <div class="post-content">
          <p>{{ post()!.content }}</p>
          @if (post()!.images && post()!.images.length > 0) {
            <div class="post-images">
              @for (imageUrl of post()!.images; track imageUrl) {
                <img [src]="imageUrl" alt="Post image" class="post-image">
              }
            </div>
          }
        </div>

        <div class="post-stats">
          <button
            class="like-btn"
            [class.liked]="isLiked(post()!)"
            (click)="toggleLike(post()!)"
            type="button"
            [disabled]="isLoading()"
          >
            <mat-icon>{{ isLiked(post()!) ? 'favorite' : 'favorite_border' }}</mat-icon>
            <span>{{ post()!.likesCount }}</span>
          </button>
          <span class="comment-count">{{ post()!.commentsCount }} bình luận</span>
        </div>

        <!-- Comment Form -->
        @if (authService.isAuthenticated()) {
          <div class="comment-form">
            <div class="comment-input-wrapper">
              <input
                type="text"
                placeholder="Viết bình luận..."
                [(ngModel)]="newCommentContent"
                (keyup.enter)="createComment()"
                [disabled]="isLoading()"
              />
              <button
                class="send-btn"
                (click)="createComment()"
                type="button"
                [disabled]="isLoading() || !newCommentContent().trim()"
              >
                <mat-icon>send</mat-icon>
              </button>
            </div>
          </div>
        }
      </div>

      <!-- Comments Section -->
      <div class="comments-section">
        <h3>Bình luận ({{ comments().length }})</h3>
        
        @if (isLoadingComments()) {
          <div class="loading-comments">
            <mat-icon>refresh</mat-icon>
            <p>Đang tải bình luận...</p>
          </div>
        } @else if (comments().length === 0) {
          <div class="empty-comments">
            <mat-icon>chat_bubble_outline</mat-icon>
            <p>Chưa có bình luận nào. Hãy là người đầu tiên bình luận!</p>
          </div>
        } @else {
          @for (comment of comments(); track comment.id) {
            <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: comment, post: post()!, level: 0 }"></ng-container>
          }
        }

        <!-- Recursive Comment Template -->
        <ng-template #commentTemplate let-comment let-post="post" let-level="level">
          <div 
            class="comment-item" 
            [id]="'comment-' + comment.id"
            [class.reply-item]="level > 0"
            [class.highlight-comment]="highlightedCommentId === comment.id"
            [style.margin-left.px]="level * 20"
          >
            <div class="comment-author-avatar">
              @if (comment.author.avatar) {
                <img [src]="comment.author.avatar" alt="Avatar">
              } @else {
                {{ getInitials(comment.author.fullName) }}
              }
            </div>
            <div class="comment-content">
              <div class="comment-header">
                <strong>{{ comment.author.fullName }}</strong>
                <span class="comment-time">{{ formatDate(comment.createdAt) }}</span>
              </div>
              <p>{{ comment.content }}</p>
              <div class="comment-actions">
                <button
                  class="reply-btn"
                  (click)="startReply(comment.id)"
                  type="button"
                  [disabled]="isLoading()"
                >
                  <mat-icon>reply</mat-icon>
                  <span>Phản hồi</span>
                </button>
                @if (canManage() || comment.author.id === authService.user()?.id) {
                  <button
                    class="delete-comment-btn"
                    (click)="deleteComment(comment, post)"
                    title="Xóa bình luận"
                    type="button"
                    [disabled]="isLoading()"
                  >
                    <mat-icon>delete</mat-icon>
                  </button>
                }
              </div>

              <!-- Reply Form -->
              @if (isReplyingTo(comment.id)) {
                <div class="reply-form">
                  <div class="reply-author-avatar">
                    {{ getInitials(authService.user()?.name || 'U') }}
                  </div>
                  <div class="reply-input-wrapper">
                    <input
                      type="text"
                      placeholder="Viết phản hồi..."
                      [value]="getReplyContent(comment.id)"
                      (input)="setReplyContent(comment.id, $any($event.target).value)"
                      (keyup.enter)="submitReply(post.id, comment.id)"
                      (keyup.escape)="cancelReply(comment.id)"
                      [disabled]="isLoading()"
                    />
                    <div class="reply-actions">
                      <button
                        class="cancel-btn"
                        (click)="cancelReply(comment.id)"
                        type="button"
                        [disabled]="isLoading()"
                      >
                        Hủy
                      </button>
                      <button
                        class="send-btn"
                        (click)="submitReply(post.id, comment.id)"
                        type="button"
                        [disabled]="isLoading() || !getReplyContent(comment.id).trim()"
                      >
                        Gửi
                      </button>
                    </div>
                  </div>
                </div>
              }

              <!-- Show reply count and expand/collapse button -->
              @if (comment.replies && comment.replies.length > 0) {
                <div class="reply-actions-header">
                  <button
                    class="view-replies-btn"
                    (click)="toggleCommentExpanded(comment.id)"
                    type="button"
                  >
                    <mat-icon>{{ isCommentExpanded(comment.id) ? 'expand_less' : 'expand_more' }}</mat-icon>
                    <span>
                      {{ isCommentExpanded(comment.id) ? 'Ẩn' : 'Xem' }} {{ countTotalReplies(comment) }} phản hồi
                    </span>
                  </button>
                </div>
              }

              <!-- Render nested replies recursively if expanded -->
              @if (comment.replies && comment.replies.length > 0 && isCommentExpanded(comment.id)) {
                <div class="comment-replies">
                  @for (reply of comment.replies; track reply.id) {
                    <ng-container *ngTemplateOutlet="commentTemplate; context: { $implicit: reply, post: post, level: level + 1 }"></ng-container>
                  }
                </div>
              }
            </div>
          </div>
        </ng-template>
      </div>
    }
  </div>
</div>

<app-footer></app-footer>

