// scripts/create-postgres-migrations.js
// Script Ä‘á»ƒ táº¡o migrations má»›i cho PostgreSQL tá»« schema hiá»‡n táº¡i
const { execSync } = require('child_process');
const fs = require('fs');
const path = require('path');

const migrationsDir = path.join(__dirname, '..', 'src', 'prisma', 'migrations');
const backupDir = path.join(__dirname, '..', 'src', 'prisma', 'migrations.sqlite.backup');

// Load .env.prod
require('dotenv').config({ path: path.join(__dirname, '..', '.env.prod') });

console.log('ğŸ”„ Creating PostgreSQL migrations...\n');

// Backup migrations cÅ© náº¿u chÆ°a backup
if (fs.existsSync(migrationsDir) && !fs.existsSync(backupDir)) {
  console.log('ğŸ“¦ Backing up SQLite migrations...');
  fs.renameSync(migrationsDir, backupDir);
  console.log('âœ… Backed up to:', backupDir);
}

// Táº¡o thÆ° má»¥c migrations má»›i
if (!fs.existsSync(migrationsDir)) {
  fs.mkdirSync(migrationsDir, { recursive: true });
}

// Táº¡o migration_lock.toml vá»›i PostgreSQL
const lockFile = path.join(migrationsDir, 'migration_lock.toml');
fs.writeFileSync(lockFile, `# Please do not edit this file manually
# It should be added in your version-control system (e.g., Git)
provider = "postgresql"
`);

console.log('âœ… Created migration_lock.toml with PostgreSQL provider\n');

// Táº¡o migrations má»›i tá»« schema (dÃ¹ng migrate dev Ä‘á»ƒ táº¡o, khÃ´ng apply)
console.log('ğŸš€ Creating initial migration for PostgreSQL...');
console.log('   (This will create migration files, not apply them)\n');
try {
  execSync(
    'npx prisma migrate dev --name init_postgresql --schema=./src/prisma/schema.prisma',
    { 
      stdio: 'inherit',
      cwd: path.join(__dirname, '..'),
      env: { ...process.env }
    }
  );
  console.log('\nâœ… Migrations created and applied successfully!');
  console.log('\nğŸ“ You can now use: npm run prisma:migrate:prod (for future migrations)');
} catch (error) {
  console.error('\nâŒ Error creating migration:', error.message);
  process.exit(1);
}

